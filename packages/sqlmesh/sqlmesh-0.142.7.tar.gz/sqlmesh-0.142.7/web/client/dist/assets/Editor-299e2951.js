import{r as m,g as oe,j as e,c as h,i as E,v as A,f as Ie,b as P,a as T,m as w,I as q,B as F,l as _,ah as ze,H as V,S as Z,P as le,a6 as ve,a7 as Ae,a8 as Qe,ai as Ee,_ as Oe,d as Te,s as Be,e as He,q as We,F as z,D as $e,a9 as Ge,aj as Ve}from"./index-4a39458b.js";import{u as G,M as qe}from"./project-89a86d21.js";import{S as be}from"./SplitPane-03695e46.js";import{E as $,M as Ue}from"./file-314b3444.js";import{u as j}from"./editor-1d351a08.js";import{I as b}from"./Input-409169a4.js";import{X as Ye,L as Xe}from"./ListboxShow-0137dbde.js";import{B as we}from"./Banner-f18b661d.js";import{r as D,T as de}from"./Tab-90da3049.js";import{g as ue,G as Je,F as Ze,T as Ke}from"./help-ae1c0fc5.js";import{M as es,u as Ce,a as ie,b as ss,c as ts,C as ls}from"./context-a9c80ac3.js";import{v as ne,M as ns,P as rs}from"./PlusCircleIcon-858f124c.js";import{D as as}from"./ReportErrors-3ded62d5.js";import"./transition-a8e1d9f0.js";import"./index-8e84c8dc.js";import"./_commonjs-dynamic-modules-302442b1.js";import"./help-68063aae.js";import"./SourceList-34d2dbe6.js";import"./pluralize-451f0df4.js";function os({title:s,titleId:t,...n},o){return m.createElement("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"currentColor","aria-hidden":"true",ref:o,"aria-labelledby":t},n),s?m.createElement("title",{id:t},s):null,m.createElement("path",{fillRule:"evenodd",d:"M3 6.75A.75.75 0 013.75 6h16.5a.75.75 0 010 1.5H3.75A.75.75 0 013 6.75zM3 12a.75.75 0 01.75-.75h16.5a.75.75 0 010 1.5H3.75A.75.75 0 013 12zm0 5.25a.75.75 0 01.75-.75h16.5a.75.75 0 010 1.5H3.75a.75.75 0 01-.75-.75z",clipRule:"evenodd"}))}const is=m.forwardRef(os),Se=is;function cs({title:s,titleId:t,...n},o){return m.createElement("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"currentColor","aria-hidden":"true",ref:o,"aria-labelledby":t},n),s?m.createElement("title",{id:t},s):null,m.createElement("path",{fillRule:"evenodd",d:"M12 3.75a.75.75 0 01.75.75v6.75h6.75a.75.75 0 010 1.5h-6.75v6.75a.75.75 0 01-1.5 0v-6.75H4.5a.75.75 0 010-1.5h6.75V4.5a.75.75 0 01.75-.75z",clipRule:"evenodd"}))}const ds=m.forwardRef(cs),us=ds;function ms({title:s,titleId:t,...n},o){return m.createElement("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"currentColor","aria-hidden":"true",ref:o,"aria-labelledby":t},n),s?m.createElement("title",{id:t},s):null,m.createElement("path",{d:"M15 3.75H9v16.5h6V3.75zM16.5 20.25h3.375c1.035 0 1.875-.84 1.875-1.875V5.625c0-1.036-.84-1.875-1.875-1.875H16.5v16.5zM4.125 3.75H7.5v16.5H4.125a1.875 1.875 0 01-1.875-1.875V5.625c0-1.036.84-1.875 1.875-1.875z"}))}const fs=m.forwardRef(ms),xs=fs;function hs(s){switch(s){case $.SQL:return"SQL";case $.PY:return"Python";case $.YAML:case $.YML:return"YAML";default:return"Plain Text"}}function ps(s,t){return s.file.extension===$.SQL&&s.file.isLocal&&oe(t)}const L=function({text:t,children:n,className:o}){return e.jsxs("small",{className:h("font-bold whitespace-nowrap text-xs",o),children:[E(t)&&e.jsxs("span",{children:[t,":Â "]}),n]})};function gs({text:s,className:t}){return e.jsx("span",{className:h("font-normal",t),children:s})}function js({ok:s,className:t}){return e.jsx("span",{className:h("inline-block w-2 h-2 rounded-full",A(s)&&"bg-warning-500",Ie(s)&&"bg-success-500",P(s)&&"bg-danger-500",t)})}L.Text=gs;L.Light=js;const I={Model:"model",Test:"test",Audit:"audit",Macro:"macro",Hook:"hook",Log:"log",Config:"config",Seed:"seed",Metric:"metric",Schema:"schema",Unknown:"unknown"};function vs({tab:s}){const t=T(i=>i.isModel),n=j(i=>i.engine),o=j(i=>i.dialects),d=j(i=>i.refreshTab);m.useEffect(()=>{var c;const i=(c=o[0])==null?void 0:c.dialect_name;A(s.dialect)&&E(i)&&a(i)},[o,s]);function a(i){s.dialect=i,d(s),n.postMessage({topic:"dialect",payload:s.dialect})}return e.jsxs("div",{className:"flex w-full items-center px-2 min-h-[2rem] overflow-hidden",children:[s.file.isRemote&&e.jsx(L,{className:"mr-2",text:"Saved",children:e.jsx(L.Light,{ok:P(s.file.isChanged)})}),s.file.isRemote&&s.file.isSQL&&e.jsx(L,{className:"mr-2",text:"Formatted",children:e.jsx(L.Light,{ok:s.file.isFormatted})}),e.jsx(L,{className:"mr-2",text:"Language",children:e.jsx(L.Text,{text:hs(s.file.extension)})}),ps(s,o)&&e.jsx(L,{className:"mr-2",text:"Dialect",children:e.jsx(b,{size:w.sm,children:({className:i,size:c})=>e.jsx(b.Selector,{className:i,size:c,list:o.map(x=>({text:x.dialect_title,value:q(x.dialect_name)?"sqlglot":x.dialect_name})),onChange:x=>{a(x)},value:s.dialect})})}),t(s.file.path)&&!q(s.dialect)&&e.jsx(L,{className:"mr-2",text:"Dialect",children:e.jsx(L.Text,{text:s.dialect})}),e.jsx(L,{className:"mr-2",text:"SQLMesh Type",children:e.jsx(L.Text,{text:bs(s.file.path)})})]})}function bs(s){return q(s)?I.Unknown:s.startsWith("models")?I.Model:s.startsWith("tests")?I.Test:s.startsWith("logs")?I.Log:s.startsWith("macros")?I.Macro:s.startsWith("hooks")?I.Hook:s.startsWith("seeds")?I.Seed:s.startsWith("metrics")?I.Metric:["config.yaml","config.yml","config.py"].includes(s)?I.Config:["external_models.yaml","schema.yaml"].includes(s)?I.Schema:I.Unknown}function ws(){const s=T(r=>r.modules),t=T(r=>r.models),n=T(r=>r.lastSelectedModel),o=T(r=>r.setLastSelectedModel),d=G(r=>r.files),a=G(r=>r.selectedFile),i=G(r=>r.setSelectedFile),c=j(r=>r.tab),x=j(r=>r.tabs),l=j(r=>r.replaceTab),f=j(r=>r.createTab),N=j(r=>r.selectTab),k=j(r=>r.addTab),[p,y]=m.useMemo(()=>{const r=[],v=[];return x.forEach(C=>{C.file.isLocal&&r.push(C),C.file.isRemote&&v.push(C)}),[r,v]},[x]);m.useEffect(()=>{if(A(a)||(c==null?void 0:c.file)===a||a instanceof qe||P(s.hasFiles))return;o(t.get(a.path));const r=f(a);E(c)&&c.file instanceof Ue&&P(c.file.isChanged)&&c.file.isRemote&&P(x.has(a))?l(c,r):k(r),N(r)},[a,s]),m.useEffect(()=>{if(A(n))return;const r=d.get(n.path);A(r)||i(r)},[n]);function R(){const r=f();k(r),N(r),i(r.file)}return e.jsxs("div",{className:"flex items-center",children:[e.jsx(F,{className:"h-6 m-0 ml-1 mr-2 border-none",variant:_.Alternative,size:w.sm,onClick:r=>{r.stopPropagation(),R()},children:e.jsx(us,{className:"inline-block w-3 h-4"})}),e.jsxs("ul",{className:"w-full whitespace-nowrap min-h-[2rem] max-h-[2rem] overflow-hidden overflow-x-auto hover:scrollbar scrollbar--horizontal",children:[p.map((r,v)=>e.jsx(Ne,{tab:r,title:`Custom SQL ${v+1}`},r.id)),y.map(r=>e.jsx(Ne,{tab:r,title:r.file.name},r.id))]})]})}function Ne({tab:s,title:t}){const n=m.useRef(null),o=T(l=>l.addConfirmation),d=G(l=>l.setSelectedFile),a=j(l=>l.tab),i=j(l=>l.closeTab);m.useEffect(()=>{A(s)||(s.el=n.current??void 0,(a==null?void 0:a.id)===s.id&&setTimeout(()=>{var l;(l=s==null?void 0:s.el)==null||l.scrollIntoView({behavior:"smooth",inline:"center"})},300))},[n,s,a]);function c(){s.file.isChanged?o({headline:"Closing Tab",description:"All unsaved changes will be lost. Do you want to close the tab anyway?",yesText:"Yes, Close Tab",noText:"No, Cancel",action:()=>{i(s.file)}}):i(s.file)}const x=s.file.id===(a==null?void 0:a.file.id);return e.jsx("li",{ref:n,className:h("inline-block py-1 pr-2 last-child:pr-0 overflow-hidden text-center overflow-ellipsis cursor-pointer"),onClick:l=>{l.stopPropagation(),d(s.file)},children:e.jsxs("span",{className:h("flex border-2 justify-between items-center pl-1 pr-1 py-[0.125rem] min-w-[8rem] rounded-md group border-transparent border-r border-r-theme-darker dark:border-r-theme-lighter",x?"bg-neutral-200 border-neutral-200 text-neutral-900 dark:bg-dark-lighter dark:border-dark-lighter dark:text-primary-500":"bg-trasparent hover:bg-theme-darker dark:hover:bg-theme-lighter"),children:[e.jsx("small",{className:"text-xs",children:t}),e.jsx("small",{className:h("group-hover:hidden text-xs inline-block ml-3 mr-1 w-2 h-2 rounded-full",s.file.isChanged?"bg-warning-500":"bg-transparent")}),e.jsx(Ye,{className:"hidden group-hover:inline-block text-neutral-600 dark:text-neutral-100 w-4 h-4 ml-2 mr-0 cursor-pointer",onClick:l=>{l.stopPropagation(),c()}})]})})}const ye=24*60*60*1e3,Ns=1e3,J=50;function ys({tab:s,isOpen:t=!0,toggle:n}){const o=T(i=>i.models),d=T(i=>i.isModel),a=m.useMemo(()=>o.get(s.file.path),[s,o]);return e.jsx("div",{className:h("flex flex-col w-full h-full items-center overflow-hidden"),children:d(s.file.path)?E(a)&&e.jsx(Es,{tab:s,model:a,isOpen:t,toggle:n}):e.jsx(Ts,{tab:s,isOpen:t,toggle:n})})}function Es({tab:s,model:t,isOpen:n=!0,toggle:o}){const d=T(c=>c.environment),a=T(c=>c.environments),i=Array.from(a).filter(({isRemote:c})=>c).map(({name:c})=>({text:c,value:c}));return e.jsxs(D.Group,{children:[e.jsxs("div",{className:"flex w-full items-center",children:[e.jsx(F,{className:h("h-6 w-6 !px-0 border-none bg-neutral-10 dark:bg-neutral-20",n?"text-secondary-500 dark:text-secondary-300":"text-neutral-500 dark:text-neutral-300"),variant:_.Info,size:w.sm,onClick:c=>{c.stopPropagation(),o==null||o()},children:e.jsx(Se,{className:"w-4 h-4"})}),n&&e.jsx(de,{className:"flex justify-center items-center",list:["Evaluate","Columns",i.length>1&&d.isRemote&&"Diff"].filter(Boolean)})]}),n&&e.jsxs(D.Panels,{className:"h-full w-full overflow-hidden",children:[e.jsx(D.Panel,{unmount:!1,className:h("flex flex-col w-full h-full relative overflow-hidden","ring-white ring-opacity-60 ring-offset-2 ring-offset-blue-400 focus:outline-none focus:ring-2"),children:e.jsx(Ps,{model:t})}),e.jsx(D.Panel,{unmount:!1,className:"text-xs w-full h-full ring-white ring-opacity-60 ring-offset-2 ring-offset-blue-400 focus:outline-none focus:ring-2 px-2",children:e.jsx(es,{nodeId:t.fqn,columns:t.columns,disabled:P(t.isModelSQL),withHandles:!1,withSource:!1,withDescription:!0,limit:10})}),i.length>1&&d.isRemote&&e.jsx(D.Panel,{unmount:!1,className:h("flex flex-col w-full h-full relative overflow-hidden","ring-white ring-opacity-60 ring-offset-2 ring-offset-blue-400 focus:outline-none focus:ring-2"),children:e.jsx(ks,{tab:s,model:t,list:i.filter(({value:c})=>d.name!==c),target:{text:d.name,value:d.name}})})]})]})}function Ts({tab:s,isOpen:t=!0,toggle:n}){return e.jsxs(D.Group,{children:[e.jsxs("div",{className:"flex w-full items-center",children:[e.jsx(F,{className:h("h-6 w-6 !px-0 border-none bg-neutral-10 dark:bg-neutral-20",t?"text-secondary-500 dark:text-secondary-300":"text-neutral-500 dark:text-neutral-300"),variant:_.Info,size:w.sm,onClick:o=>{o.stopPropagation(),n==null||n()},children:e.jsx(Se,{className:"w-4 h-4"})}),t&&e.jsx(de,{className:"flex justify-center items-center",list:["Run Query","Diff"]})]}),t&&e.jsxs(D.Panels,{className:"h-full w-full overflow-hidden",children:[e.jsx(D.Panel,{unmount:!1,className:h("flex flex-col w-full h-full relative overflow-hidden","ring-white ring-opacity-60 ring-offset-2 ring-offset-blue-400 focus:outline-none focus:ring-2"),children:e.jsx(Ss,{tab:s})}),e.jsx(D.Panel,{unmount:!1,className:h("flex flex-col w-full h-full relative overflow-hidden","ring-white ring-opacity-60 ring-offset-2 ring-offset-blue-400 focus:outline-none focus:ring-2"),children:e.jsx(Ds,{})})]})]})}function Cs({children:s}){return e.jsx("fieldset",{className:"flex my-3",children:s})}function K({children:s}){return e.jsx("div",{className:"flex w-full h-full py-1 overflow-hidden overflow-y-auto hover:scrollbar scrollbar--vertical",children:s})}function ee({children:s}){return e.jsx("div",{className:"flex w-full py-1 px-1 justify-end",children:s})}function Ss({tab:s}){const t=j(x=>x.setPreviewQuery),n=j(x=>x.setPreviewTable),o=j(x=>x.engine),{refetch:d,isFetching:a,cancel:i}=ze({sql:s.file.content});m.useEffect(()=>()=>{i()},[]);function c(){n(void 0),t(s.file.content),d().then(({data:x})=>{n(ue(x))})}return e.jsxs(e.Fragment,{children:[e.jsx(K,{}),e.jsx(V,{}),e.jsxs(ee,{children:[e.jsx(F,{size:w.sm,variant:_.Alternative,onClick:x=>{x.stopPropagation(),o.postMessage({topic:"format",payload:{sql:s.file.content}})},children:"Format"}),a?e.jsxs("div",{className:"flex items-center",children:[e.jsx(Z,{className:"w-3"}),e.jsx("small",{className:"text-xs text-neutral-400 block mx-2",children:"Running Query..."}),e.jsx(F,{size:w.sm,variant:_.Danger,onClick:x=>{x.stopPropagation(),i()},children:"Cancel"})]}):e.jsx(F,{size:w.sm,variant:_.Alternative,disabled:a,onClick:x=>{x.stopPropagation(),c()},children:"Run Query"})]})]})}function Ps({model:s}){const t=T(p=>p.environment),n=T(p=>p.isModel),o=j(p=>p.setPreviewQuery),d=j(p=>p.setPreviewTable),[a,i]=m.useState({model:s.displayName,start:le(ve(Date.now()-ye)),end:le(new Date),execution_time:le(ve(Date.now()-ye)),limit:1e3}),{refetch:c}=Ae({model:a.model,start:a.start,end:a.end,execution_time:a.execution_time,dialect:s.dialect,pretty:!0}),{refetch:x,isFetching:l,cancel:f}=Qe(a),N=n(s.path)&&Object.values(a).every(Boolean);m.useEffect(()=>()=>{f()},[]);function k(){o(void 0),d(void 0),c().then(({data:p})=>{o(p==null?void 0:p.sql)}),x().then(({data:p})=>{d(ue(p))})}return e.jsxs(e.Fragment,{children:[e.jsx(K,{children:e.jsxs("form",{className:"w-full",children:[P(N)&&e.jsx(Cs,{children:e.jsx(we,{variant:_.Warning,children:e.jsxs(we.Description,{className:"w-full mr-2 text-sm",children:["Please fill out all fields to ",e.jsx("b",{children:"evaluate the model"}),"."]})})}),e.jsxs("fieldset",{className:"px-2 w-full text-neutral-500",children:[e.jsx(b,{className:"w-full mx-0",label:"Start Date",size:w.sm,children:({className:p})=>e.jsx(b.Textfield,{className:h(p,"w-full"),placeholder:"02/11/2023",value:a.start,onInput:y=>{y.stopPropagation(),i({...a,start:y.target.value??""})}})}),e.jsx(b,{className:"w-full mx-0",label:"End Date",size:w.sm,children:({className:p})=>e.jsx(b.Textfield,{className:h(p,"w-full"),placeholder:"02/13/2023",value:a.end,onInput:y=>{y.stopPropagation(),i({...a,end:y.target.value??""})}})}),e.jsx(b,{className:"w-full mx-0",label:"Execution Time",size:w.sm,children:({className:p})=>e.jsx(b.Textfield,{className:h(p,"w-full"),placeholder:"02/13/2023",value:a.execution_time,onInput:y=>{y.stopPropagation(),i({...a,execution_time:y.target.value??""})}})}),E(a.limit)&&e.jsx(b,{className:"w-full mx-0",label:"Limit",size:w.sm,children:({className:p})=>e.jsx(b.Textfield,{className:h(p,"w-full"),type:"number",placeholder:"1000",value:a.limit,onInput:y=>{y.stopPropagation(),i({...a,limit:y.target.valueAsNumber??Ns})}})})]})]})}),e.jsx(V,{}),e.jsx(ee,{children:e.jsx("div",{className:"flex w-full justify-end",children:n(s.path)&&l?e.jsxs("div",{className:"flex items-center",children:[e.jsx(Z,{className:"w-3"}),e.jsx("small",{className:"text-xs text-neutral-400 block mx-2",children:"Evaluating..."}),e.jsx(F,{size:w.sm,variant:_.Danger,onClick:p=>{p.stopPropagation(),f()},children:"Cancel"})]}):e.jsx(F,{size:w.sm,variant:_.Alternative,disabled:P(N)||l||t.isInitialProd,onClick:p=>{p.stopPropagation(),k()},children:"Evaluate"})})})]})}function ks({tab:s,model:t,list:n,target:o}){const d=T(g=>g.isModel),a=j(g=>g.setPreviewDiff),[i,c]=m.useState(n[0].value),[x,l]=m.useState(J),[f,N]=m.useState(""),[k,p]=m.useState(""),{refetch:y,isFetching:R,cancel:r}=Ee({source:i,target:o.value,model_or_snapshot:t.name,limit:x,on:f,where:k}),v=m.useCallback(()=>{a(void 0),y().then(({data:g})=>{a(g)})},[t.name,t.hash]);m.useEffect(()=>()=>{r()},[]),m.useEffect(()=>{c(n[0].value)},[n]);const C=d(s.file.path)&&[i,o,x].every(Boolean);return e.jsxs(e.Fragment,{children:[e.jsx(K,{children:e.jsx("form",{className:"w-full",children:e.jsxs("fieldset",{className:"px-2 w-full text-neutral-500",children:[e.jsx(b,{className:"w-full mx-0",label:"Source",disabled:n.length<2,size:w.sm,children:({disabled:g,className:M})=>e.jsx(b.Selector,{className:h(M,"w-full"),list:n,value:i,disabled:g,onChange:c})}),e.jsx(b,{className:"w-full mx-0",label:"Target",disabled:!0,children:({disabled:g,className:M})=>e.jsx(b.Textfield,{className:h(M,"w-full"),disabled:g,value:o.value})}),e.jsx(b,{className:"w-full mx-0",label:"Limit",size:w.sm,children:({className:g})=>e.jsx(b.Textfield,{className:h(g,"w-full"),type:"number",placeholder:"1000",value:x,onInput:M=>{M.stopPropagation(),l(M.target.valueAsNumber??J)}})}),e.jsx(b,{className:"w-full mx-0",label:"ON",size:w.sm,children:({className:g})=>e.jsx(b.Textfield,{className:h(g,"w-full"),placeholder:"s.id = t.id",value:f,onInput:M=>{M.stopPropagation(),N(M.target.value)}})}),e.jsx(b,{className:"w-full mx-0",label:"WHERE",size:w.sm,children:({className:g})=>e.jsx(b.Textfield,{className:h(g,"w-full"),placeholder:"id > 10",value:k,onInput:M=>{M.stopPropagation(),p(M.target.value)}})})]})})}),e.jsx(V,{}),e.jsx(ee,{children:e.jsx("div",{className:"flex w-full justify-end items-center px-2",children:R?e.jsxs("div",{className:"flex items-center",children:[e.jsx(Z,{className:"w-3"}),e.jsx("small",{className:"text-xs text-neutral-400 block mx-2",children:"Getting Diff..."}),e.jsx(F,{size:w.sm,variant:_.Danger,onClick:g=>{g.stopPropagation(),r()},children:"Cancel"})]}):e.jsx(F,{className:"ml-2",size:w.sm,variant:_.Alternative,disabled:P(C)||R,onClick:g=>{g.stopPropagation(),v()},children:"Get Diff"})})})]})}function Ds(){const s=j(r=>r.setPreviewDiff),[t,n]=m.useState(""),[o,d]=m.useState(""),[a,i]=m.useState(J),[c,x]=m.useState(""),[l,f]=m.useState(""),{refetch:N,isFetching:k,cancel:p}=Ee({source:t,target:o,limit:a,on:c,where:l});m.useEffect(()=>()=>{p()},[]);function y(){s(void 0),N().then(({data:r})=>{s(r)})}const R=[t,o,a,c].every(Boolean);return e.jsxs(e.Fragment,{children:[e.jsx(K,{children:e.jsx("form",{className:"w-full",children:e.jsxs("fieldset",{className:"px-2 w-full text-neutral-500",children:[e.jsx(b,{className:"w-full mx-0",label:"Source",size:w.sm,children:({className:r})=>e.jsx(b.Textfield,{className:h(r,"w-full"),placeholder:"exp.tst_model__dev",value:t,onInput:v=>{v.stopPropagation(),n(v.target.value)}})}),e.jsx(b,{className:"w-full mx-0",label:"Target",size:w.sm,children:({className:r})=>e.jsx(b.Textfield,{className:h(r,"w-full"),placeholder:"exp.tst_snapshot__1353336088",value:o,onInput:v=>{v.stopPropagation(),d(v.target.value)}})}),e.jsx(b,{className:"w-full mx-0",label:"Limit",size:w.sm,children:({className:r})=>e.jsx(b.Textfield,{className:h(r,"w-full"),type:"number",placeholder:"1000",value:a,onInput:v=>{v.stopPropagation(),i(v.target.valueAsNumber??J)}})}),e.jsx(b,{className:"w-full mx-0",label:"ON",size:w.sm,children:({className:r})=>e.jsx(b.Textfield,{className:h(r,"w-full"),placeholder:"s.id = t.id",value:c,onInput:v=>{v.stopPropagation(),x(v.target.value)}})}),e.jsx(b,{className:"w-full mx-0",label:"WHERE",size:w.sm,children:({className:r})=>e.jsx(b.Textfield,{className:h(r,"w-full"),placeholder:"id > 10",value:l,onInput:v=>{v.stopPropagation(),f(v.target.value)}})})]})})}),e.jsx(V,{}),e.jsx(ee,{children:k?e.jsxs("div",{className:"flex items-center",children:[e.jsx(Z,{className:"w-3"}),e.jsx("small",{className:"text-xs text-neutral-400 block mx-2",children:"Getting Diff..."}),e.jsx(F,{size:w.sm,variant:_.Danger,onClick:r=>{r.stopPropagation(),p()},children:"Cancel"})]}):e.jsx(F,{className:"ml-2",size:w.sm,variant:_.Alternative,disabled:P(R)||k,onClick:r=>{r.stopPropagation(),y()},children:"Get Diff"})})]})}const U="s__",Y="t__",me="NULL";function Ms({source_schema:s,target_schema:t},n,o){const d=Array.from(new Set(o.flat())),a=Object.keys(s),i=Object.keys(t),x=Array.from(new Set(a.concat(i))).filter(N=>a.includes(N)&&i.includes(N)),l=a.filter(N=>!i.includes(N)),f=i.filter(N=>!a.includes(N));return{all:Array.from(new Set([d,n.modifiedColumns&&x,n.addedColumns&&f,n.removedColumns&&l].filter(Boolean).flat())),added:f.length,deleted:l.length,modified:x.length-d.length}}function _s(s,t,n){const o=Object.values(s.row_diff.sample)[0]??{},d=[],a=[],i=[];return Object.keys(o).forEach(c=>{W(s,c,n)?a.push(c):H(s,c,n)?d.push(c):i.push(c)}),{all:[t.modifiedRows&&i,t.addedRows&&a,t.removedRows&&d].filter(Boolean).flat(),added:a.length,deleted:d.length,modified:i.length}}function ce(s,t,n){const o=Q(s,U,t,n),d=Q(s,Y,t,n);return o!==d}function H(s,t,n){return n.every(([o,d])=>{const a=Q(s,U,o,t),i=Q(s,Y,d,t);return E(a)&&A(i)})}function W(s,t,n){return n.every(([o,d])=>{const a=Q(s,U,o,t),i=Q(s,Y,d,t);return A(a)&&E(i)})}function re(s,t,n,o){return n in s.schema_diff.added||n in s.schema_diff.removed?!1:t.some(d=>P(W(s,d,o))&&P(H(s,d,o))&&ce(s,n,d))}function Q(s,t,n,o){var d;return(d=s.row_diff.sample[`${t}${n}`])==null?void 0:d[o]}function Ls(s,t,n){return Q(s,U,t,n)??me}function Fs(s,t,n){return Q(s,Y,t,n)??me}function Rs({diff:s}){const[t,n]=m.useState({modifiedRows:!0,addedRows:!0,removedRows:!0,modifiedColumns:!0,addedColumns:!0,removedColumns:!0}),o=Ms(s.schema_diff,t,s.on),d=_s(s,t,s.on),a=t.addedRows&&!t.removedRows&&!t.modifiedRows,i=!t.addedRows&&t.removedRows&&!t.modifiedRows,c=Array.from(new Set(s.on.flat())),x=Object.values(s.row_diff.sample).some(l=>Object.keys(l).length>0);return e.jsxs("div",{className:"px-2 h-full flex flex-col rounded-lg",children:[x&&e.jsxs(e.Fragment,{children:[e.jsx(As,{diff:s,rows:d,columns:o}),e.jsx("div",{className:"mt-2 mb-1 flex rounded-lg items-center",children:e.jsx("div",{className:"w-full flex justify-end items-center",children:e.jsx(Xe,{options:Object.keys(t).reduce((l,f)=>(l[f]=N=>n(k=>({...k,[f]:N})),l),{}),value:Object.keys(t).map(l=>P(t[l])?void 0:l).filter(Boolean)})})})]}),e.jsx("div",{className:"overflow-auto h-full hover:scrollbar scrollbar--horizontal scrollbar--vertical",children:e.jsxs("table",{cellPadding:0,cellSpacing:0,className:"w-full text-xs text-neutral-600 dark:text-neutral-200 font-normal border-separate",children:[e.jsx("thead",{className:"sticky bg-theme top-0 z-10",children:e.jsx("tr",{children:o.all.map(l=>e.jsx("th",{colSpan:re(s,d.all,l,s.on)?2:1,className:h("text-left whitespace-nowrap py-1 px-2 font-bold",l in s.schema_diff.added?"border-t-2 border-l-2 border-r-2 border-success-500":l in s.schema_diff.removed?"border-t-2 border-l-2 border-r-2 border-danger-500":c.includes(l)?"border-brand-500 border-l-2 border-t-2 border-r-2":"border-r border-b border-neutral-100 dark:border-neutral-700 last:border-r-0",c.includes(l)?"bg-brand-10":"bg-neutral-5"),children:e.jsxs("div",{className:"flex justify-between",children:[e.jsxs("div",{className:"mr-2",children:[e.jsx("span",{children:l}),"Â ",e.jsxs("small",{className:"text-neutral-500 font-medium",children:["(",s.schema_diff.source_schema[l]??s.schema_diff.target_schema[l],")"]})]}),P(c.includes(l))&&e.jsx("div",{className:"ml-2",children:e.jsxs("small",{className:"inline-block bg-neutral-10 px-2 py-0.5 rounded-full",children:[Math.round(d.all.filter(f=>ce(s,l,f)).length/d.all.length*100),"%"]})})]})},l))})}),e.jsx("tbody",{children:oe(d.all)?d.all.map(l=>e.jsx("tr",{children:o.all.map(f=>re(s,d.all,f,s.on)?e.jsxs(e.Fragment,{children:[e.jsx("td",{className:h("p-1 border-r border-b border-neutral-100 dark:border-neutral-700 last:border-r-0",W(s,l,s.on)&&"bg-success-10 text-success-500",H(s,l,s.on)&&"bg-danger-5 text-danger-500"),children:e.jsx("div",{className:h("px-2 py-1 whitespace-nowrap font-bold rounded-md ",W(s,l,s.on)&&"bg-success-10 text-success-500",H(s,l,s.on)&&"bg-danger-5 text-danger-500"),children:Ls(s,f,l)})},`${l}-${f}-source`),e.jsx("td",{className:h("p-1 border-r border-b border-neutral-100 dark:border-neutral-700 last:border-r-0",W(s,l,s.on)&&"bg-success-10 text-success-500",H(s,l,s.on)&&"bg-danger-5 text-danger-500"),children:e.jsx("div",{className:h("px-2 py-1 whitespace-nowrap font-bold rounded-md",ce(s,f,l)&&"bg-primary-10 text-primary-500",W(s,l,s.on)&&"!bg-success-10 !text-success-500",H(s,l,s.on)&&"!bg-danger-5 !text-danger-500"),children:Fs(s,f,l)})},`${l}-${f}-target`)]}):e.jsx("td",{className:h("p-1",f in s.schema_diff.added?"bg-success-10 border-l-2 border-r-2 border-success-500 text-success-500 font-bold":f in s.schema_diff.removed?"bg-danger-5 border-l-2 border-r-2 border-danger-500 !text-danger-500 font-bold":c.includes(f)?"border-brand-500 border-l-2 border-r-2":"border-r border-b border-neutral-100 dark:border-neutral-700 last:border-r-0",H(s,l,s.on)&&"!bg-danger-5 text-danger-500 font-bold",W(s,l,s.on)&&"bg-success-10 text-success-500 font-bold"),children:e.jsx("div",{className:h("px-2 py-1 whitespace-nowrap rounded-md",(f in s.schema_diff.added||W(s,l,s.on))&&"bg-success-10 text-success-500 font-bold",(f in s.schema_diff.removed||H(s,l,s.on))&&"!bg-danger-5 !text-danger-500 font-bold"),children:Q(s,U,f,l)??Q(s,Y,f,l)??me})},`${l}-${f}`))},l)):e.jsx(Je,{columns:o.all.length>0?o.all.length:void 0})}),oe(d.all)&&e.jsx("tfoot",{className:"sticky bg-theme bottom-0",children:e.jsx("tr",{children:o.all.map(l=>re(s,d.all,l,s.on)?e.jsxs(e.Fragment,{children:[e.jsx("th",{className:h("text-left whitespace-nowrap px-2 py-1 border-r border-t border-neutral-100 dark:border-neutral-700 last:border-r-0",c.includes(l)?"bg-brand-10":"bg-neutral-10"),children:"Source"},`${l}-source`),e.jsx("th",{className:h("text-left whitespace-nowrap px-2 py-1 border-r border-t border-neutral-100 dark:border-neutral-700 last:border-r-0",c.includes(l)?"bg-brand-10":"bg-primary-10"),children:"Target"},`${l}-target`)]}):e.jsxs("th",{className:h("text-left whitespace-nowrap px-2 py-1 font-bold",l in s.schema_diff.added?"border-b-2 border-l-2 border-r-2 border-success-500":l in s.schema_diff.removed?"border-b-2 border-l-2 border-r-2 border-danger-500":c.includes(l)?"border-brand-500 border-l-2 border-b-2 border-r-2":"border-r border-t border-neutral-100 dark:border-neutral-700 last:border-r-0",c.includes(l)?"bg-brand-10":"bg-neutral-10"),children:[(l in s.schema_diff.removed||i)&&e.jsx("span",{children:"Source"}),(l in s.schema_diff.added||a)&&e.jsx("span",{children:"Target"})]},l))})})]})}),e.jsxs("div",{className:"flex justify-between items-center px-2 mt-2",children:[e.jsx(Ze,{count:d.all.length}),e.jsx(Is,{})]})]})}function Is(){const s=[["Grain","bg-brand-500"],["Changed","bg-primary-500"],["Added","bg-success-500"],["Deleted","bg-danger-500"]];return e.jsx("div",{className:"flex text-xs",children:s.map(([t="",n])=>e.jsx(zs,{text:t,className:n},t))})}function zs({text:s,className:t}){return e.jsxs("div",{className:"flex ml-2 items-center",children:[e.jsx("span",{className:h("inline-block w-3 h-3 mr-2 rounded-full",t)}),e.jsx("small",{className:"text-neutral-600 dark:text-neutral-400",children:s})]})}function As({diff:s,rows:t,columns:n}){return e.jsx(ne,{defaultOpen:!1,children:({open:o})=>e.jsxs(e.Fragment,{children:[e.jsxs(ne.Button,{className:"flex items-center w-full justify-between rounded-lg text-left text-sm px-4 pt-3 pb-2 bg-neutral-10 hover:bg-theme-darker dark:hover:bg-theme-lighter text-neutral-600 dark:text-neutral-400",children:[e.jsx("h2",{className:"whitespace-nowrap text-xl font-bold mb-1",children:"Stats"}),o?e.jsx(ns,{className:"h-6 w-6 text-primary-500"}):e.jsx(rs,{className:"h-6 w-6 text-primary-500"})]}),e.jsx(ne.Panel,{className:"px-4 pb-2 text-sm text-neutral-500",children:e.jsxs("div",{className:"p-2 grid grid-cols-3 gap-4 mb-3",children:[e.jsx(ae,{text:"Row Count Change",children:e.jsxs("p",{className:"text-6xl font-light text-primary-500 mt-3",children:[Math.round(Math.abs(s.row_diff.count_pct_change)),e.jsx("small",{className:"text-sm",children:"%"})]})}),e.jsxs(ae,{text:"Column Count Change",count:t.all.length,children:[e.jsx("p",{className:"text-center text-6xl font-light text-primary-500 mt-3",children:t.modified}),e.jsx("p",{className:"text-center text-6xl font-light text-success-500 mt-3",children:t.added}),e.jsx("p",{className:"text-center text-6xl font-light text-danger-500 mt-3",children:t.deleted})]}),e.jsxs(ae,{text:"Column Changes",count:n.all.length,children:[e.jsx("p",{className:"text-center text-6xl font-light text-primary-500 mt-3",children:n.modified}),e.jsx("p",{className:"text-center text-6xl font-light text-success-500 mt-3",children:n.added}),e.jsx("p",{className:"text-center text-6xl font-light text-danger-500 mt-3",children:n.deleted})]})]})})]})})}function ae({text:s,children:t,className:n,count:o}){return e.jsxs("div",{className:h("rounded-xl overflow-hidden px-3 py-6 bg-primary-10",n),children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("h3",{className:"text-neutral-500 dark:text-neutral-300 text-sm font-bold",children:s}),E(o)&&e.jsx("div",{children:e.jsx("small",{className:"inline-block px-2 py-0.5 bg-neutral-10 rounded-full",children:o})})]}),e.jsx("div",{className:"grid grid-cols-3 gap-2",children:t})]})}const Qs=m.lazy(async()=>await Oe(()=>import("./ModelLineage-5782ca7d.js"),[])),B={Query:"Query",Table:"Data Preview",Console:"Logs",Lineage:"Lineage",Diff:"Diff",Errors:"Errors"};function Os({tab:s,className:t}){const{errors:n,removeError:o}=Te(),d=Be(),a=T(g=>g.models),i=T(g=>g.isModel),c=j(g=>g.direction),x=j(g=>g.previewQuery),l=j(g=>g.previewTable),f=j(g=>g.previewDiff),N=j(g=>g.setDirection),[k,p]=m.useState(-1),y=Ce(s.file.path,g=>{d(`${He.DataCatalogModels}/${g.name}`)}),R=a.get(s.file.path),r=P(s.file.isEmpty)&&E(R)&&i(s.file.path),v=n.size>0,C=m.useMemo(()=>[E(l)&&B.Table,E(x)&&s.file.isRemote&&B.Query,r&&B.Lineage,E(f)&&B.Diff,v&&B.Errors].filter(Boolean),[s.id,l,x,f,r,n,v]);return m.useEffect(()=>{E(l)?p(C.indexOf(B.Table)):p(0)},[l]),m.useEffect(()=>{E(f)?p(C.indexOf(B.Diff)):p(0)},[f]),m.useEffect(()=>{E(r)?p(C.indexOf(B.Lineage)):p(0)},[r]),m.useEffect(()=>{p(v?C.indexOf(B.Errors):0)},[v]),m.useEffect(()=>{for(const g of n)We([z.Fetchdf,z.EvaluateModel,z.RenderQuery,z.ColumnLineage,z.ModelLineage,z.TableDiff,z.Table,z.SaveFile],g.key)&&o(g)},[l,f,x,r]),e.jsx("div",{className:h("w-full h-full flex flex-col text-prose overflow-auto hover:scrollbar scrollbar--vertical",t),children:$e(C)?e.jsx("div",{className:"flex justify-center items-center w-full h-full",children:e.jsx("h3",{className:"text-md",children:"No Data To Preview"})}):e.jsxs(D.Group,{onChange:p,selectedIndex:k,children:[e.jsx(de,{list:C,children:e.jsx("div",{className:"ml-2",children:e.jsx(F,{className:"!m-0 !py-0.5 px-[0.25rem] border-none",variant:_.Alternative,size:w.sm,onClick:()=>{N(c==="horizontal"?"vertical":"horizontal")},children:e.jsx(xs,{"aria-label":c==="horizontal"?"Use vertical layout":"Use horizontal layout",className:"text-primary-500 w-5"})})})},C.join("-")),e.jsxs(D.Panels,{className:"h-full w-full overflow-hidden",children:[E(l)&&e.jsx(D.Panel,{unmount:!1,className:h("w-full h-full pt-4 relative px-2","ring-white ring-opacity-60 ring-offset-2 ring-offset-blue-400 focus:outline-none focus:ring-2"),children:e.jsx(Ke,{data:l})}),E(x)&&s.file.isRemote&&e.jsx(D.Panel,{unmount:!1,className:"w-full h-full ring-white ring-opacity-60 ring-offset-2 ring-offset-blue-400 focus:outline-none focus:ring-2 p-2",children:e.jsx("div",{className:"w-full h-full p-2 bg-primary-10 rounded-lg overflow-auto hover:scrollbar scrollbar--horizontal scrollbar--vertical",children:e.jsx(ie,{type:$.SQL,content:x??"",extensions:y,className:"text-xs"})})}),r&&e.jsx(D.Panel,{unmount:!1,className:h("w-full h-full ring-white ring-opacity-60 ring-offset-2 ring-offset-blue-400 focus:outline-none focus:ring-2"),children:e.jsx(m.Suspense,{fallback:e.jsx(Ge,{children:"Loading Model page..."}),children:e.jsx(Qs,{model:R})})}),E(f==null?void 0:f.row_diff)&&e.jsx(D.Panel,{unmount:!1,className:h("w-full h-full ring-white ring-opacity-60 ring-offset-2 ring-offset-blue-400 focus:outline-none focus:ring-2 py-2"),children:e.jsx(Rs,{diff:f},s.id)}),v&&e.jsx(D.Panel,{unmount:!1,className:"w-full h-full ring-white ring-opacity-60 ring-offset-2 ring-offset-blue-400 focus:outline-none focus:ring-2 py-2",children:e.jsx("ul",{className:"w-full h-full p-2 overflow-auto hover:scrollbar scrollbar--vertical scrollbar--horizontal",children:Array.from(n).reverse().map(g=>e.jsx("li",{className:"bg-danger-10 mb-4 last:m-0 p-2 rounded-md",children:e.jsx(as,{scope:g.key,error:g})},g.id))})})]})]},s.id)})}function fe(){const s=j(t=>t.tab);return e.jsxs("div",{className:"w-full h-full flex flex-col overflow-hidden",children:[e.jsx(ws,{}),e.jsx(V,{}),A(s)?e.jsx(xe,{}):e.jsx(Pe,{tab:s})]})}function xe(){return e.jsx("div",{className:"flex justify-center items-center w-full h-full",children:e.jsx("div",{className:"p-4 text-center text-theme-darker dark:text-theme-lighter",children:e.jsx("h2",{className:"text-3xl",children:"Select File or Add New SQL Tab"})})})}function Pe({tab:s}){const{errors:t,addError:n,removeError:o}=Te(),d=T(u=>u.environment),a=T(u=>u.models),i=T(u=>u.isModel),c=G(u=>u.files),x=G(u=>u.selectedFile),l=G(u=>u.setSelectedFile),f=j(u=>u.direction),N=j(u=>u.engine),k=j(u=>u.previewTable),p=j(u=>u.previewDiff),y=j(u=>u.refreshTab),R=j(u=>u.updateStoredTabsIds),r=j(u=>u.setPreviewQuery),v=j(u=>u.setPreviewTable),C=j(u=>u.setPreviewDiff),g=j(u=>u.setDialects),{setManuallySelectedColumn:M}=ss(),ke=m.useCallback(function(u){l(c.get(u.path))},[c]),De=m.useCallback(function(u,S){M([u,S])},[]),se=ts(),he=Ce(s.file.path,ke,De),[pe,te]=m.useState(!1),Me=m.useMemo(()=>[...se,{key:"Mod-Enter",win:"Ctrl-Enter",preventDefault:!0,stopPropagation:!0,run(u){const S=u.state.doc.toString();v(void 0),r(S);for(const O of t)O.key===z.Fetchdf&&o(O);return Ve({sql:S}).then(O=>{v(ue(O))}).catch(O=>{n(z.Fetchdf,{...O,errorKey:z.Fetchdf,trigger:"Editor -> customSQLKeymaps",message:O.message,timestamp:Date.now(),origin:"useQueryTimeout"})}),!0}}],[se,t]),ge=m.useCallback(u=>{if(u.data.topic==="dialects"){const S=a.get(s.file.path);s.dialect=(S==null?void 0:S.dialect)??"",g(u.data.payload),y(s)}if(u.data.topic==="format"){if(q(u.data.payload))return;s.file.content=u.data.payload,y(s)}},[s.id]),je=m.useCallback(function(S){s.file.content=S,y(s)},[s.id]);m.useEffect(()=>(N.addEventListener("message",ge),te(!1),A(x)&&l(s==null?void 0:s.file),()=>{N.removeEventListener("message",ge)}),[s.id]),m.useEffect(()=>{r(void 0),v(void 0),C(void 0),R()},[s.id,s.file.fingerprint]),m.useEffect(()=>{C(void 0)},[d]);function _e(){const u=a.get(s.file.path),S=P(s.file.isEmpty)&&E(u)&&i(s.file.path);return t.size>0||[k,p].some(Boolean)||S?[70,30]:[100,0]}function Le(){const u=a.get(s==null?void 0:s.file.path);return pe&&(E(u)&&i(s.file.path)||s.file.isLocal)&&P(q(s.file.content))?[70,30]:[100,0]}const X=32,Fe=2;return e.jsxs(be,{className:h("w-full h-full overflow-hidden",f==="vertical"?"flex flex-col":"flex"),sizes:_e(),direction:f,minSize:[X,0],snapOffset:0,children:[e.jsxs("div",{className:h("flex flex-col",f==="vertical"?"w-full ":"h-full"),children:[e.jsxs(be,{className:"flex h-full overflow-hidden",sizes:Le(),minSize:X,snapOffset:X,handleDrag:(u,S)=>{const Re=S.parent.getBoundingClientRect().width*(u[1]??0)/100;te(Re>=X+Fe)},children:[e.jsxs("div",{className:"flex flex-col h-full",children:[s.file.isLocal&&e.jsx(ie,{type:$.SQL,dialect:s.dialect,keymaps:Me,content:s.file.content,extensions:he,onChange:je}),s.file.isRemote&&e.jsx(ls,{keymaps:se,path:s.file.path,children:({file:u,keymaps:S})=>e.jsx(ie,{type:u.extension,dialect:s.dialect,extensions:he,keymaps:S,content:u.content,onChange:je})})]}),e.jsx("div",{className:"flex flex-col h-full",children:e.jsx(ys,{tab:s,toggle:()=>te(u=>!u),isOpen:pe})})]},s.id),e.jsx(V,{}),e.jsx(vs,{tab:s},s.file.fingerprint)]}),e.jsx(Os,{tab:s,className:h(f==="vertical"?"flex flex-col":"flex")})]},f)}fe.Empty=xe;fe.Loading=xe;fe.Main=Pe;export{fe as default};
